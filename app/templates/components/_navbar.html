<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid">
        <!-- Sidebar Toggle (Mobile) -->
        <button class="btn btn-link d-lg-none me-2" type="button"
                data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas"
                aria-controls="sidebarOffcanvas" aria-label="Toggle navigation">
            <i class="bi bi-list fs-4"></i>
        </button>

        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('main.dashboard') }}">
            <img src="{{ url_for('static', filename='img/logo-dark.png') }}" alt="GigRoute" height="48" class="me-2">
            <div class="d-none d-sm-flex flex-column">
                <span class="brand-text">GigRoute</span>
                <span class="navbar-credit">Cree par Arnaud Porcel</span>
            </div>
        </a>

        <!-- Search (Desktop) -->
        <form class="d-none d-lg-flex mx-auto search-form" action="{{ url_for('main.search') }}" method="GET" style="width: 400px;" data-no-loading="true" id="navbar-search-form">
            <div class="input-group">
                <input type="search" class="form-control" name="q" placeholder="Rechercher..."
                       value="{{ request.args.get('q', '') }}" aria-label="Rechercher" id="navbar-search-input">
                <button class="btn btn-outline-gold" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>

        <!-- Right Nav Items -->
        <ul class="navbar-nav ms-auto flex-row">
            <!-- Search Toggle (Mobile) -->
            <li class="nav-item d-lg-none">
                <a class="nav-link px-2" href="{{ url_for('main.search') }}">
                    <i class="bi bi-search"></i>
                </a>
            </li>

            <!-- Notifications -->
            <li class="nav-item dropdown" id="notifications-dropdown">
                <a class="nav-link px-2 position-relative" href="#" role="button"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell"></i>
                    {% if unread_notifications_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifications-badge">
                        {{ unread_notifications_count if unread_notifications_count < 100 else '99+' }}
                        <span class="visually-hidden">notifications non lues</span>
                    </span>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-end notification-dropdown" style="width: 320px; max-height: 400px; overflow-y: auto;">
                    <li class="dropdown-header d-flex justify-content-between align-items-center px-3 py-2">
                        <span class="fw-bold">Notifications</span>
                        {% if unread_notifications_count > 0 %}
                        <button type="button" class="btn btn-link btn-sm p-0 text-muted" id="mark-all-read-btn" title="Tout marquer comme lu">
                            <i class="bi bi-check2-all"></i>
                        </button>
                        {% endif %}
                    </li>
                    <li><hr class="dropdown-divider my-0"></li>
                    <div id="notifications-list">
                        {% if recent_notifications %}
                            {% for notification in recent_notifications %}
                            <li class="notification-item {{ 'unread' if not notification.is_read else '' }}" data-id="{{ notification.id }}">
                                <a class="dropdown-item py-2 {% if not notification.is_read %}bg-light{% endif %}"
                                   href="{{ notification.link if notification.link else '#' }}"
                                   onclick="markAsRead({{ notification.id }})">
                                    <div class="d-flex align-items-start">
                                        <i class="bi {{ 'bi-info-circle text-info' if notification.type == 'info' else 'bi-check-circle text-success' if notification.type == 'success' else 'bi-exclamation-triangle text-warning' if notification.type == 'warning' else 'bi-x-circle text-danger' }} me-2 mt-1"></i>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold small">{{ notification.title }}</div>
                                            {% if notification.message %}
                                            <div class="text-muted small text-truncate" style="max-width: 240px;">{{ notification.message }}</div>
                                            {% endif %}
                                            <div class="text-muted small">{{ notification.created_at|timeago }}</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="px-3 py-4 text-center text-muted">
                                <i class="bi bi-bell-slash fs-4 d-block mb-2"></i>
                                <span class="small">Aucune notification</span>
                            </li>
                        {% endif %}
                    </div>
                    <li><hr class="dropdown-divider my-0"></li>
                    <li>
                        <a class="dropdown-item text-center py-2 text-primary small" href="{{ url_for('notifications.list_notifications') }}">
                            <i class="bi bi-list-ul me-1"></i>Voir toutes les notifications
                        </a>
                    </li>
                </ul>
            </li>

            <!-- User Menu -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle px-2 d-flex align-items-center" href="#"
                   role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-1"></i>
                    <span class="d-none d-md-inline">{{ current_user.first_name }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <span class="dropdown-item-text text-muted small">
                            {{ current_user.email }}
                        </span>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('settings.profile') }}">
                            <i class="bi bi-person me-2"></i>Mon profil
                        </a>
                    </li>
                    {% if current_user.is_manager_or_above() %}
                    <li>
                        <a class="dropdown-item" href="{{ url_for('settings.index') }}">
                            <i class="bi bi-gear me-2"></i>Paramètres
                        </a>
                    </li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                            <i class="bi bi-box-arrow-right me-2"></i>Déconnexion
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</nav>

<!-- Spacer for fixed navbar -->
<div class="navbar-spacer" style="height: var(--sp-navbar-height, 60px);"></div>

<!-- Search Form Protection: Prevent accidental submissions from other forms -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const navbarSearchForm = document.getElementById('navbar-search-form');
    const navbarSearchInput = document.getElementById('navbar-search-input');

    if (navbarSearchForm) {
        navbarSearchForm.addEventListener('submit', function(e) {
            // Only allow submission if the search input has focus and content
            if (document.activeElement !== navbarSearchInput) {
                e.preventDefault();
                return false;
            }
            // Also prevent empty searches from navbar
            if (!navbarSearchInput.value.trim()) {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>

<!-- Notifications JavaScript -->
<script>
function markAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    }).then(response => {
        if (response.ok) {
            const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
            if (item) {
                item.classList.remove('unread');
                const link = item.querySelector('.dropdown-item');
                if (link) link.classList.remove('bg-light');
            }
            updateNotificationBadge();
        }
    });
}

function updateNotificationBadge() {
    fetch('/notifications/api/unread-count', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(response => response.json())
    .then(data => {
        const badge = document.getElementById('notifications-badge');
        if (data.count > 0) {
            if (badge) {
                badge.textContent = data.count < 100 ? data.count : '99+';
            } else {
                const bell = document.querySelector('#notifications-dropdown .nav-link');
                const newBadge = document.createElement('span');
                newBadge.id = 'notifications-badge';
                newBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                newBadge.textContent = data.count < 100 ? data.count : '99+';
                bell.appendChild(newBadge);
            }
        } else if (badge) {
            badge.remove();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const markAllBtn = document.getElementById('mark-all-read-btn');
    if (markAllBtn) {
        markAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(response => {
                if (response.ok) {
                    document.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');
                        const link = item.querySelector('.dropdown-item');
                        if (link) link.classList.remove('bg-light');
                    });
                    updateNotificationBadge();
                    markAllBtn.style.display = 'none';
                }
            });
        });
    }
});
</script>
