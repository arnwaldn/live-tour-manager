{% extends "layouts/dashboard.html" %}

{% block title %}Planning Équipe - {{ tour_stop.event_label }} - GigRoute{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('tours.index') }}">Tournées</a></li>
        {% if tour_stop.tour %}
        <li class="breadcrumb-item"><a href="{{ url_for('tours.detail', id=tour_stop.tour.id) }}">{{ tour_stop.tour.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item"><a href="{{ url_for('tours.stop_detail', id=tour_stop.tour.id, stop_id=tour_stop.id) }}">{{ tour_stop.event_label }}</a></li>
        <li class="breadcrumb-item active">Planning Équipe</li>
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h2 mb-1">
            <i class="bi bi-people-fill me-2"></i>Planning Équipe
        </h1>
        <p class="text-muted mb-0">
            {{ tour_stop.venue.name if tour_stop.venue else tour_stop.location_city }} -
            {{ tour_stop.date.strftime('%A %d %B %Y') }}
        </p>
    </div>
    <div class="btn-group mt-3 mt-md-0">
        <a href="{{ url_for('tours.stop_detail', id=tour_stop.tour.id, stop_id=tour_stop.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Retour
        </a>
        <a href="{{ url_for('crew.export_ical', stop_id=tour_stop.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-calendar-plus me-1"></i>iCal
        </a>
        {% if can_edit %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#slotModal">
            <i class="bi bi-plus-lg me-1"></i>Créneau
        </button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Legend -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <small class="text-muted">Légende:</small>
            <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Confirmé</span>
            <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>En attente</span>
            <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Refusé</span>
            <span class="badge bg-secondary"><i class="bi bi-phone me-1"></i>Externe</span>
        </div>
    </div>
</div>

<!-- Timeline by Category -->
{% if slots_by_category %}
    {% for category_value, slots in slots_by_category.items() %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0">
            <h5 class="mb-0">
                {% if category_value == 'general' %}
                    <i class="bi bi-grid me-2"></i>Général
                {% else %}
                    <i class="bi bi-{{ 'music-note' if category_value == 'musicien' else 'tools' if category_value == 'technicien' else 'camera-video' if category_value == 'production' else 'palette' if category_value == 'style' else 'shield' if category_value == 'securite' else 'briefcase' }} me-2"></i>
                    {{ category_value|title }}
                {% endif %}
                <span class="badge bg-secondary ms-2">{{ slots|length }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for slot in slots %}
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card h-100" style="border-left: 4px solid {{ slot.color }};">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">{{ slot.task_name }}</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>{{ slot.time_range }}
                                        <span class="ms-2">({{ "%.1f"|format(slot.duration_hours) }}h)</span>
                                    </small>
                                </div>
                                {% if can_edit %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown" aria-label="Actions créneau">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <button class="dropdown-item" onclick="editSlot({{ slot.id }}, '{{ slot.task_name }}', '{{ slot.task_description or '' }}', '{{ slot.start_time.strftime('%H:%M') }}', '{{ slot.end_time.strftime('%H:%M') }}', '{{ slot.profession_category.value if slot.profession_category else '' }}', '{{ slot.color }}')">
                                                <i class="bi bi-pencil me-2"></i>Modifier
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-danger"
                                                    onclick="showConfirmModal('{{ url_for('crew.delete_slot', slot_id=slot.id) }}', 'Supprimer le créneau « {{ slot.task_name }} » ? Les assignations associées seront aussi supprimées.', 'Supprimer')">
                                                <i class="bi bi-trash me-2"></i>Supprimer
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>

                            {% if slot.task_description %}
                            <p class="card-text small text-muted mb-2">{{ slot.task_description }}</p>
                            {% endif %}

                            <!-- Assignments -->
                            <div class="mt-3">
                                {% for assignment in slot.assignments %}
                                <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-{{ assignment.status_color }} me-2">
                                            <i class="bi bi-{{ assignment.status_icon }}"></i>
                                        </span>
                                        <div>
                                            <span class="fw-medium">{{ assignment.person_name }}</span>
                                            {% if assignment.is_external %}
                                            <i class="bi bi-phone text-muted ms-1" title="Contact externe"></i>
                                            {% endif %}
                                            {% if assignment.call_time %}
                                            <br><small class="text-muted">Appel: {{ assignment.call_time.strftime('%H:%M') }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if can_edit %}
                                    <button type="button" class="btn btn-sm btn-link text-danger p-0"
                                            onclick="showConfirmModal('{{ url_for('crew.delete_assignment', id=assignment.id) }}', 'Retirer {{ assignment.person_name }} de ce créneau ?', 'Retirer')"
                                            aria-label="Retirer du créneau">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                {% if can_edit %}
                                <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2"
                                        onclick="openAssignModal({{ slot.id }}, '{{ slot.task_name }}')">
                                    <i class="bi bi-person-plus me-1"></i>Assigner
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3 mb-0">Aucun créneau planifié</p>
            {% if can_edit %}
            <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#slotModal">
                <i class="bi bi-plus-lg me-1"></i>Créer un créneau
            </button>
            {% endif %}
        </div>
    </div>
{% endif %}

{% if can_edit %}
<!-- Slot Modal -->
<div class="modal fade" id="slotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="slotForm" method="POST" action="{{ url_for('crew.create_slot', stop_id=tour_stop.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="slotModalTitle">Nouveau créneau</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nom de la tâche *</label>
                        <input type="text" class="form-control" name="task_name" id="slotTaskName" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="task_description" id="slotDescription" rows="2" maxlength="500"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Heure début *</label>
                            <input type="time" class="form-control" name="start_time" id="slotStartTime" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Heure fin *</label>
                            <input type="time" class="form-control" name="end_time" id="slotEndTime" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-8">
                            <label class="form-label">Catégorie</label>
                            <select class="form-select" name="profession_category" id="slotCategory">
                                <option value="">Toutes catégories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.value }}">{{ cat.value|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label">Couleur</label>
                            <input type="color" class="form-control form-control-color w-100" name="color" id="slotColor" value="#3B82F6">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="assignForm" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Assigner à <span id="assignSlotName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type d'assignation *</label>
                        <select class="form-select" name="assignment_type" id="assignType" required onchange="toggleAssignFields()">
                            <option value="user">Utilisateur système</option>
                            <option value="external">Contact externe</option>
                        </select>
                    </div>
                    <div class="mb-3" id="userField">
                        <label class="form-label">Utilisateur</label>
                        <select class="form-select" name="user_id" id="assignUser">
                            <option value="">Sélectionner...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="externalField">
                        <label class="form-label">Contact externe</label>
                        <select class="form-select" name="external_contact_id" id="assignExternal">
                            <option value="">Sélectionner...</option>
                            {% for contact in external_contacts %}
                            <option value="{{ contact.id }}">{{ contact.display_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#contactModal">
                                <i class="bi bi-plus me-1"></i>Nouveau contact
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Heure d'appel (optionnel)</label>
                        <input type="time" class="form-control" name="call_time" id="assignCallTime">
                        <small class="text-muted">Laisser vide pour utiliser l'heure de début du créneau</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Assigner</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- External Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('crew.create_contact') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Nouveau contact externe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Prénom *</label>
                            <input type="text" class="form-control" name="first_name" required maxlength="50">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Nom *</label>
                            <input type="text" class="form-control" name="last_name" required maxlength="50">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" maxlength="120">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Téléphone</label>
                        <input type="tel" class="form-control" name="phone" maxlength="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Société</label>
                        <input type="text" class="form-control" name="company" maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Profession</label>
                        <select class="form-select" name="profession_id">
                            <option value="">Aucune</option>
                            {% for prof in professions %}
                            <option value="{{ prof.id }}">{{ prof.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editSlot(id, name, description, start, end, category, color) {
    document.getElementById('slotModalTitle').textContent = 'Modifier le créneau';
    document.getElementById('slotForm').action = '/crew/slots/' + id;
    document.getElementById('slotTaskName').value = name;
    document.getElementById('slotDescription').value = description;
    document.getElementById('slotStartTime').value = start;
    document.getElementById('slotEndTime').value = end;
    document.getElementById('slotCategory').value = category;
    document.getElementById('slotColor').value = color;
    new bootstrap.Modal(document.getElementById('slotModal')).show();
}

function openAssignModal(slotId, slotName) {
    document.getElementById('assignSlotName').textContent = slotName;
    document.getElementById('assignForm').action = '/crew/slots/' + slotId + '/assign';
    document.getElementById('assignType').value = 'user';
    document.getElementById('assignUser').value = '';
    document.getElementById('assignExternal').value = '';
    document.getElementById('assignCallTime').value = '';
    toggleAssignFields();
    new bootstrap.Modal(document.getElementById('assignModal')).show();
}

function toggleAssignFields() {
    const type = document.getElementById('assignType').value;
    document.getElementById('userField').classList.toggle('d-none', type !== 'user');
    document.getElementById('externalField').classList.toggle('d-none', type !== 'external');
}

// Reset slot modal when closed
document.getElementById('slotModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('slotModalTitle').textContent = 'Nouveau créneau';
    document.getElementById('slotForm').action = '{{ url_for("crew.create_slot", stop_id=tour_stop.id) }}';
    document.getElementById('slotForm').reset();
    document.getElementById('slotColor').value = '#3B82F6';
});

</script>
{% endif %}
{% endblock %}
