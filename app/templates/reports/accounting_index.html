{% extends "layouts/dashboard.html" %}

{% block title %}Exports Comptabilité - GigRoute{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Exports Comptabilité</h1>
            <p class="text-muted mb-0">Documents pour transmission à la comptabilité</p>
        </div>
        <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour aux rapports
        </a>
    </div>

    <div class="row g-4">
        <!-- Section Bordereaux de paiement -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        Bordereaux de Paiement
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Liste complète des paiements à effectuer pour une tournée,
                        avec coordonnées bancaires des bénéficiaires.
                    </p>

                    {% if tours %}
                    <form action="" method="get" id="bordereauForm">
                        <div class="mb-3">
                            <label for="tourBordereau" class="form-label">Sélectionner une tournée</label>
                            <select class="form-select" id="tourBordereau" name="tour_id">
                                <option value="">-- Choisir une tournée --</option>
                                {% for tour in tours %}
                                <option value="{{ tour.id }}">
                                    {{ tour.name }}
                                    {% if tour.start_date %}
                                    ({{ tour.start_date.strftime('%d/%m/%Y') }})
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="downloadBordereau()">
                            <i class="bi bi-download me-1"></i> Télécharger PDF
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Aucune tournée disponible.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Section Masse Salariale -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                        Masse Salariale (CSV)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Export CSV complet de tous les paiements d'une tournée
                        pour import dans votre logiciel comptable.
                    </p>

                    {% if tours %}
                    <form action="" method="get" id="masseSalarialeForm">
                        <div class="mb-3">
                            <label for="tourMasseSalariale" class="form-label">Sélectionner une tournée</label>
                            <select class="form-select" id="tourMasseSalariale" name="tour_id">
                                <option value="">-- Choisir une tournée --</option>
                                {% for tour in tours %}
                                <option value="{{ tour.id }}">
                                    {{ tour.name }}
                                    {% if tour.start_date %}
                                    ({{ tour.start_date.strftime('%d/%m/%Y') }})
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn btn-success" onclick="downloadMasseSalariale()">
                            <i class="bi bi-download me-1"></i> Télécharger CSV
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Aucune tournée disponible.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Section Paiements a effectuer -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Paiements à Effectuer
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Liste de tous les paiements approuvés en attente de règlement,
                        toutes tournées confondues.
                    </p>

                    <a href="{{ url_for('reports.accounting_paiements_a_effectuer') }}"
                       class="btn btn-warning">
                        <i class="bi bi-download me-1"></i> Télécharger CSV
                    </a>
                </div>
            </div>
        </div>

        <!-- Section Budget Tournée -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Budget Tournée
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Rapport budgétaire complet avec répartition par catégorie
                        et statut des paiements.
                    </p>

                    {% if tours %}
                    <form action="" method="get" id="budgetForm">
                        <div class="mb-3">
                            <label for="tourBudget" class="form-label">Sélectionner une tournée</label>
                            <select class="form-select" id="tourBudget" name="tour_id">
                                <option value="">-- Choisir une tournée --</option>
                                {% for tour in tours %}
                                <option value="{{ tour.id }}">
                                    {{ tour.name }}
                                    {% if tour.start_date %}
                                    ({{ tour.start_date.strftime('%d/%m/%Y') }})
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" class="btn btn-info" onclick="downloadBudget()">
                            <i class="bi bi-download me-1"></i> Télécharger PDF
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Aucune tournée disponible.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Section Fiches Membres -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-badge me-2"></i>
                        Fiches Récapitulatives Membres
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Fiche récapitulative des paiements pour un membre de l'équipe,
                        avec possibilité de filtrer par période.
                    </p>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="membreSelect" class="form-label">Membre</label>
                            <select class="form-select" id="membreSelect">
                                <option value="">-- Choisir un membre --</option>
                                {% for member in team_members %}
                                <option value="{{ member.id }}">{{ member.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Date début (optionnel)</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">Date fin (optionnel)</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-secondary w-100" onclick="downloadFicheMembre()">
                                <i class="bi bi-download me-1"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Box -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-light border">
                <h6 class="alert-heading">
                    <i class="bi bi-lightbulb me-1"></i> Information
                </h6>
                <p class="mb-0">
                    Ces documents sont destinés à être transmis à votre comptabilité pour traitement
                    des paiements. Les fichiers CSV peuvent être importés directement dans la plupart
                    des logiciels comptables (Sage, QuickBooks, Pennylane, etc.).
                </p>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
function downloadBordereau() {
    const tourId = document.getElementById('tourBordereau').value;
    if (!tourId) {
        alert('Veuillez sélectionner une tournée');
        return;
    }
    window.location.href = '{{ url_for("reports.accounting_bordereau", tour_id=0) }}'.replace('0', tourId);
}

function downloadMasseSalariale() {
    const tourId = document.getElementById('tourMasseSalariale').value;
    if (!tourId) {
        alert('Veuillez sélectionner une tournée');
        return;
    }
    window.location.href = '{{ url_for("reports.accounting_masse_salariale", tour_id=0) }}'.replace('0', tourId);
}

function downloadBudget() {
    const tourId = document.getElementById('tourBudget').value;
    if (!tourId) {
        alert('Veuillez sélectionner une tournée');
        return;
    }
    window.location.href = '{{ url_for("reports.accounting_budget", tour_id=0) }}'.replace('0', tourId);
}

function downloadFicheMembre() {
    const userId = document.getElementById('membreSelect').value;
    if (!userId) {
        alert('Veuillez sélectionner un membre');
        return;
    }

    let url = '{{ url_for("reports.accounting_fiche_membre", user_id=0) }}'.replace('0', userId);

    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    window.location.href = url;
}
</script>
{% endblock %}
