{% extends "layouts/dashboard.html" %}

{% block title %}Feuilles de Règlement - GigRoute{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-file-earmark-text me-2"></i>Feuilles de Règlement
    </h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('reports.financial_dashboard') }}" class="btn btn-outline-primary">
            <i class="bi bi-graph-up-arrow me-1"></i>Tableau de bord
        </a>
        <a href="{{ url_for('reports.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Retour
        </a>
    </div>
</div>

<!-- Filtres -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted me-2"><i class="bi bi-funnel me-1"></i>Filtrer:</span>
            <a href="{{ url_for('reports.settlements_list', filter='all') }}"
               class="btn btn-sm {{ 'btn-primary' if filter_type == 'all' else 'btn-outline-secondary' }}">
                Tous
            </a>
            <a href="{{ url_for('reports.settlements_list', filter='past') }}"
               class="btn btn-sm {{ 'btn-primary' if filter_type == 'past' else 'btn-outline-secondary' }}">
                <i class="bi bi-clock-history me-1"></i>Passés
            </a>
            <a href="{{ url_for('reports.settlements_list', filter='future') }}"
               class="btn btn-sm {{ 'btn-primary' if filter_type == 'future' else 'btn-outline-secondary' }}">
                <i class="bi bi-calendar-event me-1"></i>À venir
            </a>
            <span class="ms-auto text-muted small">
                {{ settlements|length }} événement{{ 's' if settlements|length > 1 else '' }}
            </span>
        </div>
    </div>
</div>

<!-- Liste des Règlements -->
<div class="card">
    <div class="card-header bg-transparent">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Toutes les Feuilles de Règlement</h5>
    </div>
    <div class="card-body p-0">
        {% if settlements %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Salle</th>
                        <th>Artiste / Tour</th>
                        <th class="text-end">Recettes Brutes</th>
                        <th class="text-end">Paiement Artiste</th>
                        <th class="text-center">Remplissage</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in settlements %}
                    {% set is_past = s.date and s.date < today %}
                    <tr class="{{ 'table-light text-muted' if is_past else '' }}">
                        <td>
                            {% if s.date %}
                            <span class="{{ 'text-muted' if is_past else '' }}">
                                {{ s.date.strftime('%d/%m/%Y') }}
                            </span>
                            {% if is_past %}
                            <span class="badge bg-secondary ms-1">Passé</span>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ s.venue_name }}</strong>
                            <br>
                            <small class="text-muted">{{ s.venue_city }}{% if s.venue_country %}, {{ s.venue_country }}{% endif %}</small>
                        </td>
                        <td>
                            <span class="fw-medium">{{ s.band_name }}</span>
                            {% if s.tour_name and s.tour_name != 'Événement Libre' %}
                            <br>
                            <small class="text-muted">{{ s.tour_name }}</small>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if s.gross_revenue > 0 %}
                            <span class="text-success">{{ format_currency(s.gross_revenue, s.currency) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <strong class="{{ 'text-primary' if s.artist_payment > 0 else 'text-muted' }}">
                                {{ format_currency(s.artist_payment, s.currency) if s.artist_payment > 0 else '-' }}
                            </strong>
                            {% if s.payment_type == 'door_deal' and s.artist_payment > s.guarantee %}
                            <br>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i>Door Deal
                            </small>
                            {% elif s.guarantee > 0 %}
                            <br>
                            <small class="text-muted">Cachet</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if s.capacity > 0 %}
                            {% set fill_class = 'success' if s.fill_rate >= 75 else ('warning' if s.fill_rate >= 50 else 'secondary') %}
                            <span class="badge bg-{{ fill_class }}">{{ s.fill_rate }}%</span>
                            <br>
                            <small class="text-muted">{{ s.sold_tickets }}/{{ s.capacity }}</small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('reports.settlement', stop_id=s.stop_id) }}"
                                   class="btn btn-outline-primary" title="Voir le détail">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('reports.settlement_pdf', stop_id=s.stop_id) }}"
                                   class="btn btn-outline-danger" title="Télécharger PDF">
                                    <i class="bi bi-file-pdf"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="text-muted mt-3">Aucune feuille de règlement à afficher.</p>
            <a href="{{ url_for('tours.index') }}" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle me-1"></i>Créer une tournée
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Info Alert -->
<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Note:</strong> Les feuilles de règlement détaillent le calcul du paiement artiste
    selon la structure du deal: cachet garanti vs. pourcentage de porte (door deal).
    L'artiste reçoit le montant le plus élevé des deux.
</div>
{% endblock %}
