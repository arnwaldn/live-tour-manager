{% extends "layouts/dashboard.html" %}

{% block title %}{{ title }} - GigRoute{% endblock %}

{% block extra_css %}
<style>
.event-type-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.35em 0.65em;
    font-size: 0.875em;
    font-weight: 600;
    border-radius: 0.375rem;
}
.section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
}
.section-header i {
    font-size: 1.25rem;
}
.call-times-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
}
.tour-info {
    background: rgba(13, 110, 253, 0.1);
    border: 1px solid rgba(13, 110, 253, 0.2);
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.global_calendar') }}">Calendrier</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<h1 class="h2 mb-4">{{ title }}</h1>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-xl-10">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}

                    <!-- Section 1: Groupe et Tournée -->
                    <div class="section-header">
                        <i class="bi bi-people-fill text-primary"></i>
                        <h5 class="mb-0">Groupe et Tournée</h5>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <label for="band_id" class="form-label">Groupe <span class="text-danger">*</span></label>
                            {{ form.band_id(class="form-select" + (" is-invalid" if form.band_id.errors else ""), id="band_id") }}
                            {% if form.band_id.errors %}
                            <div class="invalid-feedback">{{ form.band_id.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="tour_id" class="form-label">Rattacher à une tournée</label>
                            {{ form.tour_id(class="form-select" + (" is-invalid" if form.tour_id.errors else ""), id="tour_id") }}
                            {% if form.tour_id.errors %}
                            <div class="invalid-feedback">{{ form.tour_id.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div id="tour-info-banner" class="tour-info mb-4" style="display: none;">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span id="tour-info-text">Cet événement sera rattaché à la tournée sélectionnée.</span>
                    </div>

                    <!-- Section 2: Type et Date -->
                    <div class="section-header">
                        <i class="bi bi-calendar-event text-primary"></i>
                        <h5 class="mb-0">Type et Date</h5>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-4">
                            <label for="event_type" class="form-label">Type d'événement <span class="text-danger">*</span></label>
                            {{ form.event_type(class="form-select" + (" is-invalid" if form.event_type.errors else ""), id="event_type") }}
                            {% if form.event_type.errors %}
                            <div class="invalid-feedback">{{ form.event_type.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                            {{ form.date(class="form-control" + (" is-invalid" if form.date.errors else ""), type="date") }}
                            {% if form.date.errors %}
                            <div class="invalid-feedback">{{ form.date.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="status" class="form-label">Statut</label>
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                            <div class="invalid-feedback">{{ form.status.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Section 3: Salle (conditionnelle) -->
                    <div id="venue-section">
                        <div class="section-header">
                            <i class="bi bi-building text-primary"></i>
                            <h5 class="mb-0">Salle</h5>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-6">
                                <label for="venue_id" class="form-label">Salle</label>
                                {{ form.venue_id(class="form-select" + (" is-invalid" if form.venue_id.errors else "")) }}
                                {% if form.venue_id.errors %}
                                <div class="invalid-feedback">{{ form.venue_id.errors[0] }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <a href="{{ url_for('venues.create') }}" target="_blank" rel="noopener noreferrer">
                                        <i class="bi bi-plus-circle me-1"></i>Créer une nouvelle salle
                                    </a>
                                </div>
                            </div>

                            <div class="col-12 col-md-6" id="show-type-field">
                                <label for="show_type" class="form-label">Type de concert</label>
                                {{ form.show_type(class="form-select" + (" is-invalid" if form.show_type.errors else "")) }}
                                {% if form.show_type.errors %}
                                <div class="invalid-feedback">{{ form.show_type.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Horaires d'appel (Call Times) -->
                    <div id="call-times-section">
                        <div class="section-header">
                            <i class="bi bi-clock-history text-primary"></i>
                            <h5 class="mb-0">Horaires d'appel</h5>
                        </div>
                        <div class="call-times-grid mb-4">
                            <div>
                                <label for="load_in_time" class="form-label">
                                    <i class="bi bi-truck text-muted me-1"></i>Chargement
                                </label>
                                {{ form.load_in_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="crew_call_time" class="form-label">
                                    <i class="bi bi-tools text-muted me-1"></i>Équipe
                                </label>
                                {{ form.crew_call_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="artist_call_time" class="form-label">
                                    <i class="bi bi-person-badge text-muted me-1"></i>Artistes
                                </label>
                                {{ form.artist_call_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="catering_time" class="form-label">
                                    <i class="bi bi-cup-hot text-muted me-1"></i>Catering
                                </label>
                                {{ form.catering_time(class="form-control", type="time") }}
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Horaires du show -->
                    <div id="show-times-section">
                        <div class="section-header">
                            <i class="bi bi-music-note-beamed text-primary"></i>
                            <h5 class="mb-0">Horaires du show</h5>
                        </div>
                        <div class="call-times-grid mb-4">
                            <div>
                                <label for="soundcheck_time" class="form-label">
                                    <i class="bi bi-soundwave text-muted me-1"></i>Soundcheck
                                </label>
                                {{ form.soundcheck_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="press_time" class="form-label">
                                    <i class="bi bi-newspaper text-muted me-1"></i>Presse
                                </label>
                                {{ form.press_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="meet_greet_time" class="form-label">
                                    <i class="bi bi-people text-muted me-1"></i>Meet & Greet
                                </label>
                                {{ form.meet_greet_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="doors_time" class="form-label">
                                    <i class="bi bi-door-open text-muted me-1"></i>Portes
                                </label>
                                {{ form.doors_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="set_time" class="form-label">
                                    <i class="bi bi-music-note-beamed text-primary me-1"></i>Set
                                </label>
                                {{ form.set_time(class="form-control", type="time") }}
                            </div>
                            <div>
                                <label for="curfew_time" class="form-label">
                                    <i class="bi bi-moon text-muted me-1"></i>Couvre-feu
                                </label>
                                {{ form.curfew_time(class="form-control", type="time") }}
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: Billetterie et financier -->
                    <div id="financial-section">
                        <div class="section-header">
                            <i class="bi bi-ticket-perforated text-primary"></i>
                            <h5 class="mb-0">Billetterie et financier</h5>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-4">
                                <label for="guarantee" class="form-label">Cachet garanti</label>
                                <div class="input-group">
                                    {{ form.guarantee(class="form-control", placeholder="0.00") }}
                                    <span class="input-group-text">€</span>
                                </div>
                            </div>

                            <div class="col-12 col-md-4">
                                <label for="ticket_price" class="form-label">Prix du billet</label>
                                <div class="input-group">
                                    {{ form.ticket_price(class="form-control", placeholder="0.00") }}
                                    <span class="input-group-text">€</span>
                                </div>
                            </div>

                            <div class="col-12 col-md-4">
                                <label for="set_length_minutes" class="form-label">Durée du set</label>
                                <div class="input-group">
                                    {{ form.set_length_minutes(class="form-control", placeholder="60") }}
                                    <span class="input-group-text">min</span>
                                </div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="ticket_url" class="form-label">Lien billetterie</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                                    {{ form.ticket_url(class="form-control" + (" is-invalid" if form.ticket_url.errors else ""),
                                       placeholder="https://...") }}
                                    {% if form.ticket_url.errors %}
                                    <div class="invalid-feedback">{{ form.ticket_url.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="age_restriction" class="form-label">Restriction d'âge</label>
                                {{ form.age_restriction(class="form-select") }}
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: Notes -->
                    <div class="section-header">
                        <i class="bi bi-sticky text-primary"></i>
                        <h5 class="mb-0">Notes</h5>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <label for="notes" class="form-label">Notes publiques</label>
                            {{ form.notes(class="form-control", rows="3", placeholder="Notes visibles par tous...") }}
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="internal_notes" class="form-label">Notes internes</label>
                            {{ form.internal_notes(class="form-control", rows="3", placeholder="Notes privées pour le management...") }}
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.global_calendar') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i>Annuler
                        </a>
                        <div>
                            {% if event %}
                            <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash me-1"></i>Supprimer
                            </button>
                            {% endif %}
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if event %}
<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cet événement ?</p>
                <p class="text-muted mb-0">Cette action est irréversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form action="{{ url_for('main.delete_standalone_event', event_id=event.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventTypeSelect = document.getElementById('event_type');
    const tourIdSelect = document.getElementById('tour_id');
    const tourInfoBanner = document.getElementById('tour-info-banner');
    const venueSection = document.getElementById('venue-section');
    const showTypeField = document.getElementById('show-type-field');
    const callTimesSection = document.getElementById('call-times-section');
    const showTimesSection = document.getElementById('show-times-section');
    const financialSection = document.getElementById('financial-section');
    const dateField = document.getElementById('date');

    // Event types that require a venue
    const venueRequiredTypes = ['show', 'studio', 'rehearsal', 'meet_greet'];
    // Event types with full show schedule
    const showTypes = ['show', 'promo', 'press', 'meet_greet'];
    // Event types with financial info
    const financialTypes = ['show'];

    function updateFormVisibility() {
        const eventType = eventTypeSelect.value;

        // Show/hide venue section based on event type
        const needsVenue = venueRequiredTypes.includes(eventType);
        venueSection.style.display = 'block';

        // Show type field only for concerts
        showTypeField.style.display = eventType === 'show' ? 'block' : 'none';

        // Call times only for events with a venue
        callTimesSection.style.display = needsVenue ? 'block' : 'none';

        // Show times for show-related events
        showTimesSection.style.display = showTypes.includes(eventType) ? 'block' : 'none';

        // Financial info only for shows
        financialSection.style.display = financialTypes.includes(eventType) ? 'block' : 'none';
    }

    function updateTourInfo() {
        const tourId = tourIdSelect.value;
        if (tourId && tourId !== '0') {
            tourInfoBanner.style.display = 'block';
        } else {
            tourInfoBanner.style.display = 'none';
        }
    }

    eventTypeSelect.addEventListener('change', updateFormVisibility);
    tourIdSelect.addEventListener('change', updateTourInfo);

    // Initialize on page load
    updateFormVisibility();
    updateTourInfo();

    // Pre-fill date from URL parameter if provided
    {% if prefill_date %}
    if (!dateField.value) {
        dateField.value = '{{ prefill_date }}';
    }
    {% endif %}
});
</script>
{% endblock %}
