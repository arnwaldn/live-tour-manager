{% extends "layouts/dashboard.html" %}

{% block title %}{{ payment.reference }} - GigRoute{% endblock %}

{% block page_header %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{{ url_for('payments.index') }}">Paiements</a></li>
                <li class="breadcrumb-item active">{{ payment.reference }}</li>
            </ol>
        </nav>
        <h1 class="h2 mb-0">
            <i class="bi bi-receipt me-2"></i>
            {{ payment.reference }}
        </h1>
    </div>
    <div class="btn-group mt-3 mt-md-0">
        {% if payment.status.value == 'draft' %}
        <a href="{{ url_for('payments.edit', payment_id=payment.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-1"></i>Modifier
        </a>
        <form action="{{ url_for('payments.submit_for_approval', payment_id=payment.id) }}" method="POST" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send me-1"></i>Soumettre
            </button>
        </form>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash me-1"></i>Supprimer
        </button>
        {% elif payment.status.value == 'pending' %}
        <form action="{{ url_for('payments.approve', payment_id=payment.id) }}" method="POST" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-lg me-1"></i>Approuver
            </button>
        </form>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
            <i class="bi bi-x-lg me-1"></i>Rejeter
        </button>
        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
            <i class="bi bi-x-circle me-1"></i>Annuler
        </button>
        {% elif payment.status.value in ['approved', 'scheduled'] %}
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#markPaidModal">
            <i class="bi bi-check-circle me-1"></i>Marquer payé
        </button>
        <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
            <i class="bi bi-x-circle me-1"></i>Annuler
        </button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Status Banner -->
        <div class="alert alert-{{ 'secondary' if payment.status.value == 'draft' else 'warning' if payment.status.value == 'pending' else 'info' if payment.status.value == 'approved' else 'primary' if payment.status.value == 'scheduled' else 'success' if payment.status.value == 'paid' else 'danger' }} d-flex align-items-center mb-4">
            <i class="bi bi-{{ 'pencil' if payment.status.value == 'draft' else 'hourglass-split' if payment.status.value == 'pending' else 'check' if payment.status.value == 'approved' else 'calendar-check' if payment.status.value == 'scheduled' else 'check-circle' if payment.status.value == 'paid' else 'x-circle' }} fs-4 me-3"></i>
            <div>
                <strong>Statut: {{ payment.status.value|upper }}</strong>
                {% if payment.status.value == 'draft' %}
                <p class="mb-0 small">Ce paiement est en brouillon. Soumettez-le pour approbation.</p>
                {% elif payment.status.value == 'pending' %}
                <p class="mb-0 small">En attente d'approbation par un manager.</p>
                {% elif payment.status.value == 'approved' %}
                <p class="mb-0 small">Approuvé le {{ payment.approved_at.strftime('%d/%m/%Y à %H:%M') if payment.approved_at else '' }}{% if payment.approved_by %} par {{ payment.approved_by.full_name }}{% endif %}</p>
                {% elif payment.status.value == 'paid' %}
                <p class="mb-0 small">Payé le {{ payment.paid_date.strftime('%d/%m/%Y') if payment.paid_date else '' }}{% if payment.bank_reference %} - Ref: {{ payment.bank_reference }}{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Payment Details -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-cash me-2"></i>Détails du paiement</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Type de paiement</label>
                        <p class="mb-0">
                            <span class="badge bg-{{ 'success' if payment.payment_type.value == 'cachet' else 'info' if payment.payment_type.value == 'per_diem' else 'warning' if payment.payment_type.value == 'overtime' else 'secondary' }} fs-6">
                                {{ payment.payment_type.value }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Fréquence</label>
                        <p class="mb-0">{{ payment.payment_frequency.value if payment.payment_frequency else '-' }}</p>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label text-muted small">Description</label>
                        <p class="mb-0">{{ payment.description or '-' }}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Quantité</label>
                        <p class="mb-0">{{ payment.quantity }}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Taux unitaire</label>
                        <p class="mb-0">{{ "{:,.2f}".format(payment.unit_rate) if payment.unit_rate else '-' }} {{ payment.currency }}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Montant total</label>
                        <p class="mb-0 fs-4 fw-bold text-primary">{{ "{:,.2f}".format(payment.amount) }} {{ payment.currency }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Contexte</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Tournée</label>
                        <p class="mb-0">
                            {% if payment.tour %}
                            <a href="{{ url_for('tours.detail', id=payment.tour.id) }}">{{ payment.tour.name }}</a>
                            {% else %}
                            -
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Concert/Date</label>
                        <p class="mb-0">
                            {% if payment.tour_stop %}
                            <a href="{{ url_for('tours.stop_detail', tour_id=payment.tour.id, stop_id=payment.tour_stop.id) }}">
                                {{ payment.tour_stop.date.strftime('%d/%m/%Y') }} - {{ payment.tour_stop.venue.name if payment.tour_stop.venue else payment.tour_stop.location_city }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Date de travail</label>
                        <p class="mb-0">{{ payment.work_date.strftime('%d/%m/%Y') if payment.work_date else '-' }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Date échéance</label>
                        <p class="mb-0">{{ payment.due_date.strftime('%d/%m/%Y') if payment.due_date else '-' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        {% if payment.notes %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Notes</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ payment.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Beneficiary -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h6 class="mb-0"><i class="bi bi-person me-2"></i>Bénéficiaire</h6>
            </div>
            <div class="card-body">
                {% if payment.user %}
                <div class="d-flex align-items-center mb-3">
                    <div class="avatar me-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-size: 1.2rem;">
                        {{ payment.user.first_name[0] }}{{ payment.user.last_name[0] }}
                    </div>
                    <div>
                        <h6 class="mb-0">{{ payment.user.full_name }}</h6>
                        <small class="text-muted">{{ payment.user.email }}</small>
                    </div>
                </div>
                {% endif %}
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label text-muted small mb-0">Catégorie</label>
                        <p class="mb-0 small">{{ payment.staff_category.value if payment.staff_category else '-' }}</p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-muted small mb-0">Rôle</label>
                        <p class="mb-0 small">{{ payment.staff_role.value if payment.staff_role else '-' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Méthode de paiement</h6>
            </div>
            <div class="card-body">
                <p class="mb-2">{{ payment.payment_method.value if payment.payment_method else 'Non défini' }}</p>
                {% if payment.bank_reference %}
                <small class="text-muted">Référence: {{ payment.bank_reference }}</small>
                {% endif %}
            </div>
        </div>

        <!-- Audit Trail -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <small class="text-muted">Créé le</small><br>
                        {{ payment.created_at.strftime('%d/%m/%Y à %H:%M') if payment.created_at else '-' }}
                        {% if payment.created_by %}par {{ payment.created_by.full_name }}{% endif %}
                    </li>
                    {% if payment.updated_at %}
                    <li class="mb-2">
                        <small class="text-muted">Modifié le</small><br>
                        {{ payment.updated_at.strftime('%d/%m/%Y à %H:%M') }}
                    </li>
                    {% endif %}
                    {% if payment.approved_at %}
                    <li class="mb-2">
                        <small class="text-muted">Approuvé le</small><br>
                        {{ payment.approved_at.strftime('%d/%m/%Y à %H:%M') }}
                        {% if payment.approved_by %}par {{ payment.approved_by.full_name }}{% endif %}
                    </li>
                    {% endif %}
                    {% if payment.paid_date %}
                    <li>
                        <small class="text-muted">Payé le</small><br>
                        {{ payment.paid_date.strftime('%d/%m/%Y') }}
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('payments.reject', payment_id=payment.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Rejeter le paiement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reason" class="form-label">Motif du rejet</label>
                        <textarea name="reason" id="reason" class="form-control" rows="3" placeholder="Expliquez pourquoi ce paiement est rejeté..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">Rejeter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark Paid Modal -->
<div class="modal fade" id="markPaidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('payments.mark_paid', payment_id=payment.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Marquer comme payé</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bank_reference" class="form-label">Référence bancaire</label>
                        <input type="text" name="bank_reference" id="bank_reference" class="form-control" placeholder="Ex: VIR-2026-001234">
                        <small class="text-muted">Optionnel - Référence du virement ou du chèque</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Confirmer le paiement</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal (DRAFT only) -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('payments.delete', payment_id=payment.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Supprimer le paiement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer ce paiement ?</p>
                    <div class="alert alert-warning">
                        <strong>{{ payment.reference }}</strong><br>
                        {{ payment.description or 'Sans description' }}<br>
                        <strong>{{ "{:,.2f}".format(payment.amount) }} {{ payment.currency }}</strong>
                    </div>
                    <p class="text-muted small mb-0">Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Supprimer définitivement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('payments.cancel', payment_id=payment.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="reason" value="Annulation manuelle">
                <div class="modal-header border-warning">
                    <h5 class="modal-title text-warning"><i class="bi bi-x-circle me-2"></i>Annuler le paiement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir annuler ce paiement ?</p>
                    <div class="alert alert-info">
                        <strong>{{ payment.reference }}</strong><br>
                        {{ payment.description or 'Sans description' }}<br>
                        <strong>{{ "{:,.2f}".format(payment.amount) }} {{ payment.currency }}</strong>
                    </div>
                    <p class="text-muted small mb-0">Le paiement passera au statut "Annulé" et ne bloquera plus la suppression du groupe.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-x-circle me-1"></i>Confirmer l'annulation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
