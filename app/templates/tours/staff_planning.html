{% extends "layouts/base.html" %}
{% block title %}Planning - {{ stop.venue.name if stop.venue else 'Concert' }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{{ url_for('tours.index') }}">Tournées</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('tours.detail', id=tour.id) }}">{{ tour.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('tours.stop_detail', id=tour.id, stop_id=stop.id) }}">{{ stop.date.strftime('%d/%m') }}</a></li>
                    <li class="breadcrumb-item active">Planning</li>
                </ol>
            </nav>
            <h2 class="mb-0">
                <i class="bi bi-calendar2-week text-primary me-2"></i>
                Planning du Personnel
            </h2>
            <p class="text-muted mb-0">
                {{ stop.venue.name if stop.venue else 'Lieu non défini' }} -
                {{ stop.date.strftime('%A %d %B %Y') | capitalize }}
            </p>
        </div>
        <div>
            <a href="{{ url_for('tours.stop_detail', id=tour.id, stop_id=stop.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Retour
            </a>
        </div>
    </div>

    <!-- Onglets de filtrage par catégorie -->
    <ul class="nav nav-pills mb-4 flex-wrap gap-2">
        {% for tab in tabs %}
        <li class="nav-item">
            <a class="nav-link {% if current_category == tab.key %}active{% endif %}"
               href="{{ url_for('tours.staff_planning', id=tour.id, stop_id=stop.id, category=tab.key) }}">
                <i class="bi {{ tab.icon }} me-1"></i>
                {{ tab.label }}
            </a>
        </li>
        {% endfor %}
    </ul>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ total_members }}</h3>
                    <small>Membres assignés</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ planning_data | selectattr('count', 'gt', 0) | list | length }}</h3>
                    <small>Catégories actives</small>
                </div>
            </div>
        </div>
    </div>

    {% if can_edit %}
    <!-- Bouton Ajouter un créneau -->
    <div class="mb-4">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSlotModal">
            <i class="bi bi-plus-lg me-1"></i> Ajouter un créneau
        </button>
        <a href="{{ url_for('tours.stop_detail', id=tour.id, stop_id=stop.id) }}" class="btn btn-outline-primary ms-2">
            <i class="bi bi-person-plus me-1"></i> Gérer les membres
        </a>
    </div>
    {% endif %}

    <!-- Créneaux de planning -->
    {% if planning_slots %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>
                Créneaux horaires
                <span class="badge bg-light text-dark ms-2">{{ planning_slots | length }}</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Catégorie</th>
                            <th>Rôle</th>
                            <th>Horaires</th>
                            <th>Tâche</th>
                            <th>Assigné à</th>
                            {% if can_edit %}
                            <th style="width: 100px;">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for slot in planning_slots %}
                        <tr>
                            <td><span class="badge bg-secondary">{{ slot.category }}</span></td>
                            <td><strong>{{ slot.role_name }}</strong></td>
                            <td>
                                <span class="badge bg-primary">
                                    {{ slot.start_time.strftime('%H:%M') }} - {{ slot.end_time.strftime('%H:%M') }}
                                </span>
                            </td>
                            <td>{{ slot.task_description }}</td>
                            <td>
                                {% if slot.user %}
                                {{ slot.user.full_name }}
                                {% else %}
                                <span class="text-muted">Non assigné</span>
                                {% endif %}
                            </td>
                            {% if can_edit %}
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="showConfirmModal('{{ url_for('tours.delete_planning_slot', id=tour.id, stop_id=stop.id, slot_id=slot.id) }}?category={{ current_category }}', 'Supprimer ce créneau ?', 'Supprimer')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if total_members == 0 and not planning_slots %}
    <!-- Aucun membre assigné et aucun créneau -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Planning vide</h4>
            <p class="text-muted">
                Créez des créneaux horaires avec le bouton "Ajouter un créneau",<br>
                ou assignez des membres pour gérer leur planning individuel.
            </p>
        </div>
    </div>
    {% elif total_members > 0 %}

    <!-- Planning par catégorie -->
    {% for category in planning_data %}
    {% if category.members %}
    <div class="card mb-4">
        <div class="card-header bg-{{ category.color }} {% if category.color in ['primary', 'success', 'danger', 'info'] %}text-white{% endif %}">
            <h5 class="mb-0">
                <i class="bi bi-{{ category.icon }} me-2"></i>
                {{ category.label }}
                <span class="badge bg-light text-dark ms-2">{{ category.count }}</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 200px;">Membre</th>
                            <th style="width: 150px;">Profession</th>
                            <th style="width: 100px;">Convocation</th>
                            <th style="width: 100px;">Début</th>
                            <th style="width: 100px;">Fin</th>
                            <th style="width: 100px;">Pause</th>
                            <th style="width: 100px;">Repas</th>
                            <th>Notes</th>
                            {% if can_edit %}
                            <th style="width: 80px;">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in category.members %}
                        <tr data-member-id="{{ item.member.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if item.user and item.user.avatar_url %}
                                    <img src="{{ item.user.avatar_url }}" class="rounded-circle me-2" width="32" height="32" alt="">
                                    {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                        <i class="bi bi-person text-white"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ item.user.full_name if item.user else 'Inconnu' }}</strong>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{{ category.color }}">
                                    {{ item.profession.name_fr if item.profession else 'Non définie' }}
                                </span>
                            </td>
                            <td class="time-cell">
                                {% if item.call_time %}
                                <span class="badge bg-warning text-dark">{{ item.call_time.strftime('%H:%M') }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="time-cell">
                                {% if item.work_start %}
                                {{ item.work_start.strftime('%H:%M') }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="time-cell">
                                {% if item.work_end %}
                                {{ item.work_end.strftime('%H:%M') }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="time-cell">
                                {% if item.break_start and item.break_end %}
                                {{ item.break_start.strftime('%H:%M') }} - {{ item.break_end.strftime('%H:%M') }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="time-cell">
                                {% if item.meal_time %}
                                {{ item.meal_time.strftime('%H:%M') }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.notes %}
                                <small class="text-muted">{{ item.notes | truncate(30) }}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            {% if can_edit %}
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-schedule-btn"
                                        data-member-id="{{ item.member.id }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editScheduleModal">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

    {% endif %}
</div>

{% if can_edit %}
<!-- Modal d'ajout de créneau -->
<div class="modal fade" id="addSlotModal" tabindex="-1" aria-labelledby="addSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSlotModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    Ajouter un créneau
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form method="POST" action="{{ url_for('tours.add_planning_slot', id=tour.id, stop_id=stop.id) }}">
                <input type="hidden" name="category" value="{{ current_category }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="slot_category" class="form-label">Catégorie</label>
                        <select class="form-select" id="slot_category" name="slot_category" required>
                            <option value="">-- Sélectionner --</option>
                            <option value="musicien">Musiciens</option>
                            <option value="technicien">Techniciens</option>
                            <option value="production">Production</option>
                            <option value="style">Style & Costumes</option>
                            <option value="securite">Sécurité</option>
                            <option value="management">Management</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="role_name" class="form-label">Rôle / Poste</label>
                        <input type="text" class="form-control" id="role_name" name="role_name"
                               placeholder="Ex: Ingénieur son, Guitariste, Agent de sécurité..." required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="slot_start_time" class="form-label">Heure de début</label>
                            <input type="time" class="form-control" id="slot_start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="slot_end_time" class="form-label">Heure de fin</label>
                            <input type="time" class="form-control" id="slot_end_time" name="end_time" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="task_description" class="form-label">Description de la tâche</label>
                        <input type="text" class="form-control" id="task_description" name="task_description"
                               placeholder="Ex: Montage scène, Balance son, Accueil VIP..." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-lg me-1"></i> Créer le créneau
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal d'édition du planning -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel">
                    <i class="bi bi-clock me-2"></i>
                    Modifier le planning
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form id="editScheduleForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold" id="memberNameLabel">Membre</label>
                        <p class="text-muted mb-0" id="memberProfessionLabel">Profession</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="call_time" class="form-label">Heure de convocation</label>
                            <input type="time" class="form-control" id="call_time" name="call_time">
                            <small class="text-muted">Heure d'arrivée sur site</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="work_start" class="form-label">Début de travail</label>
                            <input type="time" class="form-control" id="work_start" name="work_start">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="work_end" class="form-label">Fin de travail</label>
                            <input type="time" class="form-control" id="work_end" name="work_end">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="break_start" class="form-label">Début de pause</label>
                            <input type="time" class="form-control" id="break_start" name="break_start">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="break_end" class="form-label">Fin de pause</label>
                            <input type="time" class="form-control" id="break_end" name="break_end">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="meal_time" class="form-label">Heure de repas</label>
                        <input type="time" class="form-control" id="meal_time" name="meal_time">
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"
                                  placeholder="Instructions spéciales, remarques..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Édition du planning d'un membre
    document.querySelectorAll('.edit-schedule-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const memberId = this.dataset.memberId;
            const form = document.getElementById('editScheduleForm');

            // Charger les données du membre
            fetch(`{{ url_for('tours.staff_planning', id=tour.id, stop_id=stop.id) }}/../member/${memberId}/json`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('memberNameLabel').textContent = data.user_name;
                    document.getElementById('memberProfessionLabel').textContent = data.profession;
                    document.getElementById('call_time').value = data.call_time;
                    document.getElementById('work_start').value = data.work_start;
                    document.getElementById('work_end').value = data.work_end;
                    document.getElementById('break_start').value = data.break_start;
                    document.getElementById('break_end').value = data.break_end;
                    document.getElementById('meal_time').value = data.meal_time;
                    document.getElementById('notes').value = data.notes;

                    // Mettre à jour l'action du formulaire
                    form.action = `{{ url_for('tours.staff_planning', id=tour.id, stop_id=stop.id) }}/../member/${memberId}?category={{ current_category }}`;
                })
                .catch(error => {
                    console.error('Erreur:', error);
                });
        });
    });
});

</script>
{% endblock %}
